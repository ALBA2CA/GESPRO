{% extends 'base/navbar2.html' %}

{% block content %}
<div class="flex gap-6 h-[calc(100vh-200px)]">
    {% for estado, nombre_estado in estados %}
    <div id="estado-{{ estado }}" class="flex-1 bg-gray-100 rounded-md p-4 flex flex-col border-2 border-blue-950">
        <!-- Nombre del estado con círculo de color -->
        <h3 class="text-center font-semibold mb-3 flex items-center justify-center space-x-2">
            {% comment %} Circulo de color según el estado {% endcomment %}
            {% if estado == 'PEN' %}
            <div class="w-3 h-3 bg-red-500 rounded-full"></div>
            {% elif estado == 'LPC' %}
            <div class="w-3 h-3 bg-yellow-500 rounded-full"></div>
            {% elif estado == 'EPR' %}
            <div class="w-3 h-3 bg-blue-500 rounded-full"></div>
            {% elif estado == 'COM' %}
            <div class="w-3 h-3 bg-green-500 rounded-full"></div>
            {% elif estado == 'TER' %}
            <div class="w-3 h-3 bg-purple-500 rounded-full"></div>
            {% endif %}
            <span>{{ nombre_estado }}</span>
        </h3>

        <div class="actividad-lista flex-1 flex flex-col overflow-y-auto max-h-[calc(100vh-200px)]">
            {% for actividad in actividades %}
            {% if actividad.estado == estado %}
            <div class="actividad-card bg-white p-4 mb-3 rounded-xl border-2 border-blue-500 flex flex-col justify-start"
                 data-id="{{ actividad.id }}">
                <strong class="text-gray-800">{{ actividad.nombre }}</strong>
                {% if actividad.linea_trabajo %}
                <small class="text-gray-500">Línea: {{ actividad.linea_trabajo.nombre }}</small>
                {% endif %}
                {% if actividad.producto_asociado %}
                <small class="text-gray-500">Producto: {{ actividad.producto_asociado.nombre }}</small>
                {% endif %}
                <small class="text-gray-400">{{ actividad.tipo }}</small>
            </div>
            {% endif %}
            {% endfor %}
        </div>
    </div>
    {% endfor %}
</div>

<style>
/* Fantasma solo con borde, sin contenido */
.ghost-placeholder {
    border: 2px dashed #3b82f6;
    background-color: transparent;
    border-radius: 0.75rem;
    height: 60px;
    margin-bottom: 0.75rem;
}
</style>

<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    document.querySelectorAll('.actividad-lista').forEach(lista => {
        new Sortable(lista, {
            group: 'actividades',
            animation: 150,
            ghostClass: 'ghost-placeholder',
            dragClass: 'opacity-80',

            onStart: function(evt) {
                evt.item.dataset.originalContent = evt.item.innerHTML;
                evt.item.innerHTML = '';
            },
            onEnd: function(evt) {
                evt.item.innerHTML = evt.item.dataset.originalContent;
                const actividadId = evt.item.dataset.id;
                const nuevoEstado = evt.to.closest('[id^="estado-"]').id.replace('estado-', '');
                
                fetch("{% url 'actualizar_estado' %}", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/x-www-form-urlencoded",
                        "X-CSRFToken": "{{ csrf_token }}"
                    },
                    body: `actividad_id=${actividadId}&nuevo_estado=${nuevoEstado}`
                });
            }
        });
    });
});
</script>
{% endblock %}
